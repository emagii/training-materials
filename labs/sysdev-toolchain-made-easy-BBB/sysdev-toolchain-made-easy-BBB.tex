\subchapter{Extra Lab: Simplified cross-compiler generation using Crosstool-NG}
{Objective: Get a toolchain based on the uClibc C library}

After this lab, you will have a:

\begin{itemize}
\item uclibc toolchain generated by the {\em crosstool-ng} tool
\end{itemize}

\footnote{The current generation of Crosstool-NG has problems with the ARMv7 architecture, 
which makes it hard to use with the Beaglebone for Linux}

\section{Setup}

Go to the \labdir directory.

\section{Clone the prepared scripts to build a toolchain}

\begin{verbatim}
	make toolchain
\end{verbatim}

This will use git to clone a build environment which will use 
Crosstool-NG to build a cross-compiler for an ARMv7 chip.

The command executed will be:

\begin{verbatim}
	git clone https://github.com/emagii/crosstool-ng-armv7a.git
\end{verbatim}


The setup for an ARMv7 chip is not that simple yet,
so the build has been automated. 

The next {\bf optional } lab will build the toolchain manually. 
This is an exercise left for only those interested. 
In real life, the toolchain will either be downloaded or built by a
buildsystem like {\bf Buildroot } or {\bf Yocto }.

If you did not do this previously, install the packages needed for this lab:

(You will have to supply the super-user password)

\begin{verbatim}
	make prepare
\end{verbatim}

Build the toolchain

\begin{verbatim}
	cd crosstool-ng-armv7a
	make
\end{verbatim}

If you are running this lab at home, then you just wait until the build completes.
This can take anywhere from 15 minutes to an hour, depending on your machine.

If you are running the lab during a training, inform the trainer that your build has started.
\clearpage
\subsection{Known issues}

\subsubsection{Source archives not found on the Internet}

It is frequent that Crosstool-ng aborts because it can't find a
source archive on the Internet, when such an archive has moved or has
been replaced by more recent versions. New Crosstool-ng versions ship
with updated URLs, but in the meantime, you need work-arounds.

If this happens to you, what you can do is look for the source archive by
yourself on the Internet, and copy such an archive to the \code{src}
directory in your home directory. Note that even source archives
compressed in a different way (for example, ending with \code{.gz}
instead of \code{.bz2}) will be fine too. Then, all you have to do is run
\code{./ct-ng build} again, and it will use the source archive that you
downloaded.

\subsubsection{ppl-0.10.2 compiling error with gcc 4.7.1}

If you are using gcc 4.7.1, for example in Ubuntu 12.10 (not officially
supported in these labs), compilation will fail in \code{ppl-0.10.2} with
the below error:

\begin{verbatim}
error: 'f_info' was not declared in this scope
\end{verbatim}

One solution is to add the \code{-fpermissive} flag to the
\code{CT_EXTRA_FLAGS_FOR_HOST} setting (in \code{Path and misc options
->  Extra host compiler flags}). 
\clearpage

\section{Testing the toolchain}

You can now test your toolchain. 
You need to setup the environment, and this is easy,
just  \code{source} the \code{"toolchain.sh"} script that was created during the build.

This looks like:

\begin{verbatim}
#!/bin/sh
export ARCH=arm
export GCCROOT=/usr/local/uclibc/arm-unknown-linux-uclibcgnueabihf
export PATH=$GCCROOT/bin:$PATH
export CROSS_COMPILE=arm-linux-
\end{verbatim}

Go ahead and source it:

\begin{verbatim}
source toolchain.sh
\end{verbatim}


You should also copy the script to the toplevel directory for use in later labs.

\begin{verbatim}
cp	toolchain.sh	..
\end{verbatim}

First test if you can access the compiler by checking its version:

\begin{verbatim}
arm-linux-gcc --version
\end{verbatim}

It should write out something similar to:
\begin{verbatim}
arm-linux-gcc (crosstool-NG 1.19.0) 4.8.1
Copyright (C) 2013 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

\end{verbatim}

There is a Hello World test program in the \code{example} directory
and you can try compiling this with the arm-linux-gcc compiler.

You can use the \code{file} command on your binary to make sure it has
correctly been compiled for the ARM architecture.

\section{Cleaning up}
Note: Do not do the cleanup right now, since some files will be needed 
for a later lab.

To save about 4.3 GB of storage space, do a \code{./ct-ng clean} in the
Crosstool-NG source directory. This will remove the source code of the
different toolchain components, as well as all the generated files
that are now useless since the toolchain has been installed in
\code{/usr/local/uclibc}.

The source files are located in \code{$HOME/cross/src}
